<!-- build time:Tue Oct 06 2020 17:08:35 GMT+0800 (中国标准时间) --><!DOCTYPE html><html class="theme-next pisces use-motion" lang="zh-CN"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1"><meta name="theme-color" content="#222"><meta http-equiv="Cache-Control" content="no-transform"><meta http-equiv="Cache-Control" content="no-siteapp"><link href="/lib/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css"><link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css"><link href="/css/main.css?v=5.1.4" rel="stylesheet" type="text/css"><link rel="apple-touch-icon" sizes="180x180" href="/images/mlxn.png?v=5.1.4"><link rel="icon" type="image/png" sizes="32x32" href="/images/mlxn.png?v=5.1.4"><link rel="icon" type="image/png" sizes="16x16" href="/images/mlxn.png?v=5.1.4"><link rel="mask-icon" href="/images/mlxn.png?v=5.1.4" color="#222"><meta name="keywords" content="深度学习,目标检测,"><link rel="alternate" href="/atom.xml" title="IronSublimate" type="application/atom+xml"><meta name="description" content="CoAE源码分析侯德柱源代码 fork后的代码数据加载lib&#x2F;roi_data_layer&#x2F;roibatchLoader.py1class roibatchLoader(data.Dataset):__init__12345678910def __init__(self,             roidb: List[Dict[str, Any]],             ratio_list"><meta property="og:type" content="article"><meta property="og:title" content="联合注意-联合激励代码分析"><meta property="og:url" content="https://ironsublimate.github.io/2020/09/14/33845/index.html"><meta property="og:site_name" content="IronSublimate"><meta property="og:description" content="CoAE源码分析侯德柱源代码 fork后的代码数据加载lib&#x2F;roi_data_layer&#x2F;roibatchLoader.py1class roibatchLoader(data.Dataset):__init__12345678910def __init__(self,             roidb: List[Dict[str, Any]],             ratio_list"><meta property="og:locale" content="zh_CN"><meta property="og:image" content="https://github.com/IronSublimate/One-Shot-Object-Detection-IS/blob/master/images/method.png?raw=true"><meta property="article:published_time" content="2020-09-14T14:06:56.000Z"><meta property="article:modified_time" content="2020-09-14T14:38:37.156Z"><meta property="article:author" content="侯德柱"><meta property="article:tag" content="深度学习"><meta property="article:tag" content="目标检测"><meta name="twitter:card" content="summary"><meta name="twitter:image" content="https://github.com/IronSublimate/One-Shot-Object-Detection-IS/blob/master/images/method.png?raw=true"><script type="text/javascript" id="hexo.configurations">var NexT=window.NexT||{},CONFIG={root:"/",scheme:"Pisces",version:"5.1.4",sidebar:{position:"left",display:"always",offset:12,b2t:!1,scrollpercent:!0,onmobile:!1},fancybox:!0,tabs:!0,motion:{enable:!0,async:!1,transition:{post_block:"fadeIn",post_header:"slideDownIn",post_body:"slideDownIn",coll_header:"slideLeftIn",sidebar:"slideUpIn"}},duoshuo:{userId:"0",author:"Author"},algolia:{applicationID:"",apiKey:"",indexName:"",hits:{per_page:10},labels:{input_placeholder:"Search for Posts",hits_empty:"We didn't find any results for the search: ${query}",hits_stats:"${hits} results found in ${time} ms"}}}</script><link rel="canonical" href="https://IronSublimate.github.io/2020/09/14/33845/"><title>联合注意-联合激励代码分析 | IronSublimate</title><meta name="generator" content="Hexo 4.2.1"></head><body itemscope itemtype="http://schema.org/WebPage" lang="zh-CN"><div class="container sidebar-position-left page-post-detail"><div class="headband"></div><header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader"><div class="header-inner"><div class="site-brand-wrapper"><div class="site-meta"><div class="custom-logo-site-title"><a href="/" class="brand" rel="start"><span class="logo-line-before"><i></i></span> <span class="site-title">IronSublimate</span> <span class="logo-line-after"><i></i></span></a></div><p class="site-subtitle"></p></div><div class="site-nav-toggle"><button><span class="btn-bar"></span> <span class="btn-bar"></span> <span class="btn-bar"></span></button></div></div><nav class="site-nav"><ul id="menu" class="menu"><li class="menu-item menu-item-home"><a href="/" rel="section"><i class="menu-item-icon fa fa-fw fa-home"></i><br>Home</a></li><li class="menu-item menu-item-tags"><a href="/tags/" rel="section"><i class="menu-item-icon fa fa-fw fa-tags"></i><br>Tags</a></li><li class="menu-item menu-item-categories"><a href="/categories/" rel="section"><i class="menu-item-icon fa fa-fw fa-th"></i><br>Categories</a></li><li class="menu-item menu-item-archives"><a href="/archives/" rel="section"><i class="menu-item-icon fa fa-fw fa-archive"></i><br>Archives</a></li><li class="menu-item menu-item-about"><a href="/about/" rel="section"><i class="menu-item-icon fa fa-fw fa-user"></i><br>About</a></li></ul></nav></div></header><main id="main" class="main"><div class="main-inner"><div class="content-wrap"><div id="content" class="content"><div id="posts" class="posts-expand"><article class="post post-type-normal" itemscope itemtype="http://schema.org/Article"><div class="post-block"><link itemprop="mainEntityOfPage" href="https://IronSublimate.github.io/2020/09/14/33845/"><span hidden itemprop="author" itemscope itemtype="http://schema.org/Person"><meta itemprop="name" content="侯德柱"><meta itemprop="description" content=""><meta itemprop="image" content="/images/avatar.png"></span><span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization"><meta itemprop="name" content="IronSublimate"></span><header class="post-header"><h1 class="post-title" itemprop="name headline">联合注意-联合激励代码分析</h1><div class="post-meta"><span class="post-time"><span class="post-meta-item-icon"><i class="fa fa-calendar-o"></i> </span><span class="post-meta-item-text">Posted on</span> <time title="Post created" itemprop="dateCreated datePublished" datetime="2020-09-14T22:06:56+08:00">2020-09-14 </time><span class="post-meta-divider">|</span> <span class="post-meta-item-icon"><i class="fa fa-calendar-check-o"></i> </span><span class="post-meta-item-text">Post modified&#58;</span> <time title="Post modified" itemprop="dateModified" datetime="2020-09-14T22:38:37+08:00">2020-09-14 </time></span><span class="post-meta-divider">|</span> <span class="page-pv"><i class="fa fa-file-o"></i> <span class="busuanzi-value" id="busuanzi_value_page_pv"></span></span></div></header><div class="post-body" itemprop="articleBody"><h1 id="coae源码分析">CoAE源码分析</h1><blockquote><p>侯德柱</p></blockquote><p><a href="https://github.com/timy90022/One-Shot-Object-Detection" target="_blank" rel="noopener">源代码</a> <a href="https://github.com/IronSublimate/One-Shot-Object-Detection-IS" target="_blank" rel="noopener">fork后的代码</a></p><h2 id="数据加载">数据加载</h2><h3 id="libroi_data_layerroibatchloader.py">lib/roi_data_layer/roibatchLoader.py</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">roibatchLoader</span><span class="params">(data.Dataset)</span>:</span></span><br></pre></td></tr></table></figure><ul><li><p>__init__</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self,</span></span></span><br><span class="line"><span class="function"><span class="params">             roidb: List[Dict[str, Any]],</span></span></span><br><span class="line"><span class="function"><span class="params">             ratio_list: np.ndarray,</span></span></span><br><span class="line"><span class="function"><span class="params">             ratio_index: np.ndarray,</span></span></span><br><span class="line"><span class="function"><span class="params">             query: List[Dict[int, Dict[str, Any]]],</span></span></span><br><span class="line"><span class="function"><span class="params">             batch_size: int,</span></span></span><br><span class="line"><span class="function"><span class="params">             num_classes: int,</span></span></span><br><span class="line"><span class="function"><span class="params">             training: bool = True,</span></span></span><br><span class="line"><span class="function"><span class="params">             normalize=None,</span></span></span><br><span class="line"><span class="function"><span class="params">             seen: bool = True)</span>:</span></span><br></pre></td></tr></table></figure><a id="more"></a><ul><li><p>成员变量</p><ul><li><p>self._cat_ids 在COCO中为1~90</p></li><li><p>self._classes字典，1<sub>80到1</sub>90映射</p></li><li><p>self.list</p><p>注意，filter只后的self.list应该等于imdb.list</p></li></ul></li><li><p>中间过程</p><ul><li>最后调用filter和probability</li></ul></li></ul></li><li><p>__getitem__</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">__getitem__</span><span class="params">(self, index: int)</span> -&gt; (torch.Tensor, torch.Tensor, torch.Tensor, torch.Tensor, int):</span></span><br></pre></td></tr></table></figure><ul><li><p>中间过程</p><ul><li><p>blob 即下面get_minibatch的返回值</p></li><li><p>query: np.ndarray 1x128x128x3</p><p>在138行变成torch.Tensor</p><p>之后换成1x3x128x128，并squeeze3x128x128</p></li><li><p>data是blob['data']变成Tensor，dtype=torch.float32，shape=[1,600,960,3]，已标准化</p></li></ul></li><li><p>返回值（训练）</p><ul><li><p>padding_data type=torch.float32 shape=[3,600,906]</p></li><li><p>query torch.float32 shape=[3,128,128]</p></li><li><p>im_info e.g.</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">torch.Tensor([<span class="number">600</span>,<span class="number">906</span>,<span class="number">1.4151</span>])</span><br></pre></td></tr></table></figure></li><li><p>gt_boxes_padding type=torch.float32 shape=[50x5]</p></li><li><p>num_bboxes 1</p></li></ul></li></ul></li><li><p>self.filter</p></li></ul><h3 id="libroi_data_layerminibatch.py">lib/roi_data_layer/minibatch.py</h3><ul><li><p>get_minibatch</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">get_minibatch</span><span class="params">(roidb, num_classes)</span>-&gt; Dict[str, Any]:</span></span><br></pre></td></tr></table></figure><ul><li><p>返回值</p><table><thead><tr class="header"><th>key</th><th>type</th><th>备注</th></tr></thead><tbody><tr class="odd"><td>data</td><td>np.ndarray</td><td>shape=(1,600,800,3)读取的图片 float32</td></tr><tr class="even"><td>gt_boxes</td><td>List[np.ndarray]</td><td>长度为nx5的向量(x,y,w,h,class) float32</td></tr><tr class="odd"><td>im_info</td><td>np.ndarray</td><td>shape=(1,3) float32</td></tr><tr class="even"><td>img_id</td><td>int</td><td></td></tr></tbody></table></li><li><ul><li></li></ul></li></ul></li></ul><h3 id="libroi_data_layerroidb.py">lib/roi_data_layer/roidb.py</h3><p>query类型 List[Dict[int, Dict[str, Any]]]</p><p>roidb类型 List[Dict[str, Any]]</p><ul><li><p>combined_roidb</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">combined_roidb</span><span class="params">(imdb_names: str, training=True, seen=<span class="number">1</span>)</span>\</span></span><br><span class="line"><span class="function">	-&gt; (imdb_, List[Dict[str, Any]], np.ndarray, np.ndarray, List[Dict[int, Dict[str, Any]]]):</span>:</span><br></pre></td></tr></table></figure><ul><li>参数<ul><li>imdb_names 数据集名称，为"coco_2017_train","voc_2007_trainval"等，以+分割不同的数据集</li></ul></li><li>返回值<ul><li>imdb</li></ul></li></ul></li><li><p>get_training_roidb</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">get_training_roidb</span><span class="params">(imdb, training)</span>:</span></span><br></pre></td></tr></table></figure><p>为combined_roidb的子函数</p></li><li><p>get_roidb</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">get_roidb</span><span class="params">(imdb_name: str, training: bool)</span> \</span></span><br><span class="line"><span class="function">	-&gt; (imdb_, List[Dict[str, Any]], List[Dict[int, Dict[str, Any]]], List[int]):</span></span><br></pre></td></tr></table></figure><p>为combined_roidb的子函数</p><ul><li><p>参数</p><ul><li>imdb_name 数据集名称，为"coco_2017_train","voc_2007_trainval"等</li></ul></li><li><p>过程</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">imdb.set_proposal_method(cfg.TRAIN.PROPOSAL_METHOD)</span><br></pre></td></tr></table></figure><p>如果按照cfgs的默认配置，该句会使self.roidb_handler=self.gt_roidb</p></li><li><p>返回值</p><ul><li><p><strong>imdb</strong></p></li><li><p><strong>roidb</strong> : 见下prepare_roidb</p></li><li><p><strong>cat_data</strong> 长度为81，key从0~80，每个value为一个List保存coco_class_ind对应的图片的bbox和图片路径，即<strong>query</strong></p><p>e.g.</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">    <span class="number">0</span>:[]</span><br><span class="line"></span><br><span class="line">    <span class="number">1</span>:[&#123;</span><br><span class="line">        <span class="string">'boxes'</span>: [<span class="number">339.88</span>, <span class="number">22.16</span>, <span class="number">492.76</span>, <span class="number">321.89000000000004</span>], </span><br><span class="line">        <span class="string">'image_path'</span>: <span class="string">'&lt;path to image&gt;\\000000391895.jpg'</span></span><br><span class="line">    &#125;, &#123;</span><br><span class="line">        <span class="string">'boxes'</span>: [<span class="number">471.64</span>, <span class="number">172.82</span>, <span class="number">506.56</span>, <span class="number">219.92</span>], </span><br><span class="line">        <span class="string">'image_path'</span>: <span class="string">'&lt;path to image&gt;\\000000391895.jpg'</span></span><br><span class="line">    &#125;, </span><br><span class="line">        ...</span><br><span class="line">    ]</span><br><span class="line"></span><br><span class="line">    <span class="number">2</span>:[</span><br><span class="line">        ...</span><br><span class="line">    ]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li><li><p>imdb.inverse_list长度为60，为选中的coco_cat_id(1~90)</p></li></ul></li></ul></li><li><p>prepare_roidb</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">prepare_roidb</span><span class="params">(imdb)</span> -&gt; List[Dict[str, Any]]:</span></span><br></pre></td></tr></table></figure><p>返回的imdb.roidb变成这样</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">[</span><br><span class="line">    &#123;<span class="string">'width'</span>: <span class="number">640</span>, </span><br><span class="line">     <span class="string">'height'</span>: <span class="number">360</span>, </span><br><span class="line">     <span class="string">'boxes'</span>: array([</span><br><span class="line">       [<span class="number">359</span>, <span class="number">146</span>, <span class="number">470</span>, <span class="number">358</span>],</span><br><span class="line">       [<span class="number">339</span>,  <span class="number">22</span>, <span class="number">492</span>, <span class="number">321</span>],</span><br><span class="line">       [<span class="number">471</span>, <span class="number">172</span>, <span class="number">506</span>, <span class="number">219</span>],</span><br><span class="line">       [<span class="number">486</span>, <span class="number">183</span>, <span class="number">515</span>, <span class="number">217</span>]], dtype=uint16), </span><br><span class="line">     <span class="string">'gt_classes'</span>: array([<span class="number">4</span>, <span class="number">1</span>, <span class="number">1</span>, <span class="number">2</span>]),</span><br><span class="line">     <span class="string">'gt_overlaps'</span>: &lt;<span class="number">4</span>x81 sparse matrix of type <span class="string">'&lt;class '</span>numpy.float32<span class="string">'&gt;'</span></span><br><span class="line">	<span class="keyword">with</span> <span class="number">4</span> stored elements <span class="keyword">in</span> Compressed Sparse Row format&gt;, </span><br><span class="line">     <span class="string">'flipped'</span>: <span class="literal">False</span>, </span><br><span class="line">     <span class="string">'seg_areas'</span>: array(</span><br><span class="line">         [<span class="number">12190.445</span>  , <span class="number">14107.271</span>  ,   <span class="number">708.26056</span>,   <span class="number">626.9852</span> ], dtype=float32), </span><br><span class="line">     <span class="string">'img_id'</span>: <span class="number">391895</span>, </span><br><span class="line">     <span class="string">'image'</span>: <span class="string">'&lt;path to image&gt;\\000000391895.jpg'</span>, </span><br><span class="line">     <span class="string">'max_classes'</span>: array([<span class="number">4</span>, <span class="number">1</span>, <span class="number">1</span>, <span class="number">2</span>], dtype=int64), </span><br><span class="line">     <span class="string">'max_overlaps'</span>: array([<span class="number">1.</span>, <span class="number">1.</span>, <span class="number">1.</span>, <span class="number">1.</span>], dtype=float32)&#125;</span><br><span class="line"> ...</span><br><span class="line">]</span><br></pre></td></tr></table></figure></li><li><p>rank_roidb_ratio</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">rank_roidb_ratio</span><span class="params">(roidb: List[Dict[str, Any]])</span>-&gt;(np.ndarray,np.ndarray):</span></span><br></pre></td></tr></table></figure><p>针对roidb中的每一个图像，在ratio_list中记录宽/高。返回按ratio从小到大排序号的ratio_list，ratio_index，长度为训练集图像的总数，第一个dtype为float，第二个dtype为int64</p></li><li><p>test_rank_roidb_ratio</p><p>测试时调用</p></li></ul><h3 id="trainval_net.py">trainval_net.py</h3><h4 id="sampler">sampler</h4><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">sampler</span><span class="params">(Sampler)</span>:</span></span><br></pre></td></tr></table></figure><p>继承自torch.utils.data.sampler.Sampler</p><h2 id="数据集">数据集</h2><h3 id="libdatasetsimdb.py">lib/datasets/imdb.py</h3><h4 id="imdb">imdb</h4><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">imdb</span><span class="params">(object)</span>:</span></span><br><span class="line">    <span class="string">"""Image database."""</span></span><br></pre></td></tr></table></figure><ul><li><p>__init__</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self, name: str, classes=None)</span>:</span></span><br></pre></td></tr></table></figure><ul><li>参数<ul><li>classes在所有的调用中为None</li></ul></li><li>成员变量<ul><li><strong>self._roidb_handler</strong></li><li><strong>self._classes</strong> 在子类中实现</li><li><strong>self.roidb</strong>是self._roidb_handler调用后的值</li><li><strong>self.roidb_handler</strong> 在coco.py中等于self.gt_roidb，在roidb.py中等于self.gt_roidb</li><li><strong>self.cat_data</strong> 就是query</li></ul></li></ul></li></ul><h3 id="libdatasetscoco.py">lib/datasets/coco.py</h3><h4 id="coco">coco</h4><ul><li><p>__init__</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self, image_set: str, year: str)</span>:</span></span><br></pre></td></tr></table></figure><ul><li><p>参数</p><ul><li><strong>image_set</strong> 为"train" "val" "test"</li><li><strong>year</strong>为"2014" "2017"</li></ul></li><li><p>成员变量</p><ul><li><p><strong>self._data_path</strong> 该路径下面应该有annotions和images两个文件夹</p></li><li><p><strong>self._roidb_handler</strong></p></li><li><p><strong>self._classes Tuple[(str)]</strong> 包括background</p></li><li><p><strong>self._class_to_ind</strong> 类别名到0~80的映射</p></li><li><p><strong>self._class_to_coco_cat_id</strong> 类别名到1-90映射</p></li><li><p><strong>self.coco_cat_id_to_class_ind</strong> 1<sub>90到1</sub>80的映射</p></li><li><p><strong>self.coco_class_ind_to_cat_id</strong> 1<sub>80到1</sub>90映射</p></li><li><p><strong>总之</strong> class代表类别名 coco_class_ind为1~80 coco_cat_id为1~90</p></li><li><p><strong>self._image_index</strong> =COCO.getImgIds()</p></li><li><p><strong>self._gt_splits</strong> = ('train', 'val', 'minival')</p></li><li><p><strong>self.reference_image</strong> Dict[int,Dict[int,Dict[str,Any]]]</p><p>图像检测结果字典，为每一张图像id为key，其的检测bbox的与实际对比的结果</p><p>e.g.</p><figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">    391895: &#123;</span><br><span class="line">        1: &#123;</span><br><span class="line">            'category_id': 1, </span><br><span class="line">            'category_name': 'person', </span><br><span class="line">            'score': 0.9975148439407349, </span><br><span class="line">            'iou': 0.7170171752233037</span><br><span class="line">        &#125;, </span><br><span class="line">        2: &#123;</span><br><span class="line">            'category_id': 1, </span><br><span class="line">            'category_name': 'person', </span><br><span class="line">            'score': 0.9939727187156677, </span><br><span class="line">            'iou': 0.8616664860812628</span><br><span class="line">        &#125;, </span><br><span class="line">        0: &#123;'category_id': 4, </span><br><span class="line">            'category_name': 'motorcycle', </span><br><span class="line">            'score': 0.9700725078582764, </span><br><span class="line">            'iou': 0.8821412520463373</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;, </span><br><span class="line">    522418: &#123;</span><br><span class="line">        0: &#123;</span><br><span class="line">            'category_id': 1, </span><br><span class="line">            'category_name': 'person', </span><br><span class="line">            'score': 0.9950047135353088, </span><br><span class="line">            'iou': 0.8602898932977073</span><br><span class="line">        &#125;, </span><br><span class="line">        1: &#123;</span><br><span class="line">            'category_id': 49, </span><br><span class="line">            'category_name': 'knife', </span><br><span class="line">            'score': 0.9600722193717957, </span><br><span class="line">            'iou': 0.8965148825297287</span><br><span class="line">        &#125;, </span><br><span class="line">        2: &#123;</span><br><span class="line">            'category_id': 65, </span><br><span class="line">            'category_name': 'bed', </span><br><span class="line">            'score': 0.8499319553375244, </span><br><span class="line">            'iou': 0.910496123229155</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;, </span><br><span class="line">  184613: &#123;</span><br><span class="line">        ...</span><br><span class="line">  &#125;</span><br><span class="line">    ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li><li><p><strong>self.cat_data</strong> Dict[int,List] key的范围1~90</p></li><li><p><strong>self.lis</strong>t 长度为60，是选出来用于训练的coco的cat_id，最大值90</p></li><li></li></ul></li></ul></li><li><p>filter</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">filter</span><span class="params">(self, seen: int = <span class="number">1</span>)</span>:</span></span><br></pre></td></tr></table></figure><p>根据命令行参数seen的值决定哪些类可见</p><ul><li><p>中间变量</p><ul><li><p><strong>cfg.train_categories</strong> 和cfg.test_categories**均为[1] self.list开始为[1]</p></li><li><p><strong>self.list</strong></p><p>上面两个cfg变量长度为1时self.list每4个数中在1<sub>80中取一个，保存的是cat_id的值(1</sub>90)</p></li><li><p><strong>self.inverse_list</strong>是根据上面的self.list保存1~80的值</p></li><li><p><strong>all_index</strong> 开始为0~所有图片的数量，先删掉类别在self.list中的图片</p></li><li><p>在此调用self.gt_roidb self.roidb就是self.gt_roidb的返回值</p></li><li><p>最后在self._image_index和self.roidb中删掉all_index中的图片，其保留的图片就是含有self.list中的</p></li><li><p>返回到roidb.py 的get_roidb</p></li></ul></li></ul></li><li><p>gt_roidb</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">gt_roidb</span><span class="params">(self)</span>-&gt;List[Dict[str, Any]]</span></span><br></pre></td></tr></table></figure><ul><li><p>修改成员变量self.cat_data即query</p></li><li><p>返回值</p><p>e.g.</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">[</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="string">'width'</span>: <span class="number">640</span>, </span><br><span class="line">        <span class="string">'height'</span>: <span class="number">360</span>, </span><br><span class="line">        <span class="string">'boxes'</span>: array([</span><br><span class="line">           [<span class="number">359</span>, <span class="number">146</span>, <span class="number">470</span>, <span class="number">358</span>],</span><br><span class="line">           [<span class="number">339</span>,  <span class="number">22</span>, <span class="number">492</span>, <span class="number">321</span>],</span><br><span class="line">           [<span class="number">471</span>, <span class="number">172</span>, <span class="number">506</span>, <span class="number">219</span>],</span><br><span class="line">           [<span class="number">486</span>, <span class="number">183</span>, <span class="number">515</span>, <span class="number">217</span>]], dtype=uint16), </span><br><span class="line">        <span class="string">'gt_classes'</span>: array([<span class="number">4</span>, <span class="number">1</span>, <span class="number">1</span>, <span class="number">2</span>]), </span><br><span class="line">        <span class="string">'gt_overlaps'</span>: &lt;<span class="number">4</span>x81 sparse matrix of type &lt;<span class="class"><span class="keyword">class</span> <span class="title">numpy</span>.<span class="title">float32</span>&gt;</span></span><br><span class="line">        with 4 stored elements in Compressed Sparse Row format&gt;, </span><br><span class="line">        <span class="string">'flipped'</span>: <span class="literal">False</span>, </span><br><span class="line">        <span class="string">'seg_areas'</span>: array(</span><br><span class="line">           [<span class="number">12190.445</span>  , <span class="number">14107.271</span>  , <span class="number">708.26056</span>,   <span class="number">626.9852</span> ], dtype=float32)</span><br><span class="line">    &#125;,</span><br><span class="line">	...</span><br><span class="line">]</span><br></pre></td></tr></table></figure><p>gt_classes的序号为1~80</p></li></ul></li><li><p>_load_coco_annotation</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">_load_coco_annotation</span><span class="params">(self, index)</span>:</span></span><br></pre></td></tr></table></figure><p>生成roidb和self.cat_data即query</p></li><li><p>_get_ann_file(self)</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">_get_ann_file</span><span class="params">(self)</span>:</span></span><br></pre></td></tr></table></figure><p>根据"train" "val" "test"生成对应文件的路径</p></li></ul><h3 id="libdatasetsfactory.py">lib/datasets/factory.py</h3><ul><li><p>get_imdb</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">get_imdb</span><span class="params">(name:str)</span>-&gt;imdb:</span></span><br></pre></td></tr></table></figure><ul><li>数据集名，为"coco_2017_train","voc_2007_trainval"等</li></ul></li></ul><h3 id="自定义数据集">自定义数据集</h3><p>以coco为例</p><ol type="1"><li>修改coco.py中image_path_from_index读取图片的路径</li><li>修改coco.py中_get_ann_file读取ann_file的路径</li><li>在test_val.py中加对应的数据集名称</li><li>在factory.py中加__set[name]</li></ol><h2 id="数据处理">数据处理</h2><h3 id="libmodelutilblob.py">lib/model/util/blob.py</h3><ul><li><p>crop</p><p></p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">crop</span><span class="params">(image: np.ndarray, purpose: List[float], size: int)</span> -&gt; np.ndarray:</span></span><br></pre></td></tr></table></figure><p></p><p>裁剪图像</p><ul><li>参数<ul><li>image为np.ndarray</li><li>purpose为要裁剪的位置</li><li>size是裁剪后要resize的大小</li></ul></li></ul></li><li><p>prep_im_for_blob</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">prep_im_for_blob</span><span class="params">(im: np.ndarray, pixel_means: np.ndarray, target_size: int, max_size: int)</span> -&gt; (np.ndarray, float):</span></span><br></pre></td></tr></table></figure><p>图片归一化并标准化</p><ul><li><p>参数</p><p>有用到的是im和target_size，target_size = 108</p></li><li><p>返回值</p><ul><li>处理后的图像</li><li>放大倍数，没用到</li></ul></li></ul></li><li><p>im_list_to_blob</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">im_list_to_blob</span><span class="params">(ims: List[np.ndarray])</span>-&gt;np.ndarray:</span></span><br><span class="line">    <span class="string">"""Convert a list of images into a network input.</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">    Assumes images are already prepared (means subtracted, BGR order, ...).</span></span><br></pre></td></tr></table></figure><p>将List[np.ndarray]转成np.ndarray，其shape[0]为输入的list长度</p><ul><li>返回值<ul><li>shape为(1x128x128x3)，第一维是图片数量</li></ul></li></ul></li></ul><h2 id="训练">训练</h2><ul><li><p>在coco训练的时候dataset.list和mdb.list为</p><p>[2, 3, 4, 6, 7, 8, 10, 11, 13, 15, 16, 17, 19, 20, 21, 23, 24, 25, 28, 31, 32, 34, 35, 36, 38, 39, 40, 42, 43, 44, 47, 48, 49, 51, 52, 53, 55, 56, 57, 59, 60, 61, 63, 64, 65, 70, 72, 73, 75, 76, 77, 79, 80, 81, 84, 85, 86, 88, 89, 90]</p><p>在coco测试的时候</p><p>[2, 6, 10, 15, 19, 23, 28, 34, 38, 42, 47, 51, 55, 59, 63, 70, 75, 79, 84, 88]</p></li></ul><h2 id="魔改">魔改</h2><p>roibatchLoader.filter(seen)</p><ul><li><p>我不知道roibatchLoader的self.filter(seen)有什么用，在coco上面测试</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">assert</span> dataset.list == imdb.list, (dataset.list, imdb.list)</span><br><span class="line"><span class="keyword">assert</span> dataset.list_ind == imdb.inverse_list, (dataset.list, imdb.list)</span><br></pre></td></tr></table></figure><p>均能通过</p><p>故将imdb作为形参，在roibatchLoader初始化的时候调用，取代filter以初始化list,list_ind</p></li></ul><h2 id="网络">网络</h2><figure><img src="https://github.com/IronSublimate/One-Shot-Object-Detection-IS/blob/master/images/method.png?raw=true" alt="method.png"><figcaption aria-hidden="true">method.png</figcaption></figure><h3 id="oneshotbase.py">oneshotbase.py</h3><h4 id="matchnet">matchnet</h4><ul><li><p>__init__.py</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self, inplanes: int)</span>:</span></span><br></pre></td></tr></table></figure><ul><li>参数<ul><li>inplanes赋值给self.in_channels在coco中为1024</li></ul></li><li>成员变量<ul><li>self.in_channels=1024（coco）</li><li>self.inter_channels=self.in_channels//2（in coco = 512）</li><li>self.g 输入self.in_channels 输出self.inter_channel的1x1卷积</li><li>self.W输入self.inter_channels输出self.in_channels的1x1卷积，带batch_normalize</li><li>self.Q同self.W</li><li>self.theta self.phi 输入self.in_channels输出self.inter_channels的1x1卷积</li></ul></li></ul></li><li><p>forward</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">forward</span><span class="params">(self, detect: torch.Tensor, aim: torch.Tensor)</span>:</span></span><br></pre></td></tr></table></figure><ul><li><p>参数</p><ul><li>detect是输入图像（经过resnet提特征后）size=(1,1024,38,w) 对应batch_size channels h w</li><li>aim是查询图像（经过resnet提特征后）size=(1,1024,8,8) 对应batch_size channels h w</li></ul></li><li><p>中间变量</p><ul><li><p>d_x 为 detect经过self.g并变形之后size=(1,38×w ,512) 2546=38×w w={57 38 50}</p></li><li><p>a_x 为 aim经过self.g并变形之后size=(1,64,512) 64=8×8</p></li><li><p>theta_x为aim经过self.theta并变形后 size=(1,64,512)</p></li><li><p>phi_x为detect经过self.phi并变形后size=(1,512,38×w)</p></li><li><p>f=matmul(theta_x, phi_x) size=(1,64,38×w)矩阵乘法</p></li><li><p>f_div_C为f除以第二个维度长度，并变形为(1,64,38×w)</p></li><li><p>fi_div_C为f除以最后维度长度，并变形为(1,38×w,64)</p></li><li><p>non_aim ： non-local aim size=(1,1024,8,8) =matmul(f_div_C,d_x)+aim</p></li><li><p>non_det ： non-local detect size=(1,1024,38,w) =matmul(fi_div_C,a_x)+detect。对应F(I)</p></li><li><p>c_weight：size(1,1024,1,1)见下ChannelGate</p></li><li><p>act_aim：=non_aim * c_weight size(1,1024,8,8) activation</p></li><li><p>act_det：=non_det * c_weight size(1,1024,38,w) activation <span class="math display">\[ non\_aim=W(\theta(aim)\times\phi(dectect)/(38\times w)\times g(detect))+aim\\ non\_det=Q(\theta(aim)\times\phi(dectect)/64\times g(aim))+dectect\\ act\_aim=c\_weight*non\_aim\\ act\_det=c\_weight*non\_det \]</span></p><p><span class="math display">\[ non\_det是论文中的F(I)\\ non\_aim是论文中的F(p)\\ act\_det是论文中的\tilde{F}(I)\\ act\_aim是论文中的\tilde{F}(p) \]</span></p></li></ul></li><li><p>返回值</p><p>non_det, act_det, act_aim, c_weight</p></li></ul></li></ul><h4 id="oneshotbase">OneShotBase</h4><ul><li><p>__init__.py</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self, classes:Tuple[str], class_agnostic:bool)</span>:</span></span><br></pre></td></tr></table></figure><ul><li><p>参数</p><ul><li>classes就是imdb.classes。包括__background__</li><li>class_agnostic类别不可知=False</li></ul></li><li><p>成员变量</p><ul><li><p>RCNN_base 最开始的那个特征提取网络</p></li><li><p>RCNN_bbox_pred 2048-&gt;4的全连接网络</p></li><li><p>RCNN_cls_score 2N-&gt;8-&gt;2的那个网络</p></li><li><p>RCNN_proposal_target不参与反传，这层接到rpn_proposal_layer给的proposal,主要完成proposal跟gt的配对,然后传给loss进行学习</p></li><li><p>triplet_loss = torch.nn.MarginRankingLoss <span class="math display">\[ loss(x1,x2,y)=max(0,-y*(x1-x2)+margin) \]</span></p></li><li><p>_head_to_tail 在resnet中是一个resnet layer4，感觉是roi pool之后RCNN提取特征的，roi pool的结果和query生成的~F(p)都经过</p></li></ul></li></ul></li><li><p>forward</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">forward</span><span class="params">(self, im_data:torch.Tensor, query:torch.Tensor, im_info:torch.Tensor, gt_boxes:torch.Tensor, num_boxes:torch.Tensor)</span>:</span></span><br></pre></td></tr></table></figure><ul><li><p>参数</p><ul><li>im_data图片，size=(1,3,600,600)，猜测为(batch_size, channel, height, width)</li><li>query查询图片，size=(1, 3, 128, 128)</li><li>im_info=(600,600,0.9804) size=(1, 3) 在RCNN_RPN中使用</li><li>gt_boxes size=(1,50,5)</li><li>num_boxes size=1</li></ul></li><li><p>中间变量</p><ol type="1"><li>孪生网络</li></ol><ul><li>detect_feat： detect feature为im_data过了self.RCNN_base的torch.Tensor shape=(1,1024,38,38)</li><li>query_feat： query_feature为qurey过滤self.RCNN_base的torch.Tensor shape=(1,1024,8,8)</li></ul><ol start="2" type="1"><li>non-local feature</li></ol><ul><li>rpn_feat：为target Image的Non-local Feature size=(1,1024,57,38)</li><li>act_feat：为target Image激活后的图~F(I) size=(1,1204,57,38)</li><li>act_aim：为query Image激活后的图~F(p) size=(1,1204,8,8)</li><li>c_weight：联合注意的权重 size=(1,1204,1,1)</li></ul><ol start="3" type="1"><li>rpn</li></ol><ul><li>rois size=(1,2000,5)</li><li>rpn_loss_cls=0.6905 标量 requires_grad=True</li><li>rpn_loss_bbox=0.0162标量 requires_grad=True</li></ul><ol start="4" type="1"><li>self.RCNN_proposal_target 仅在训练中有</li></ol><ul><li>rois size=(1,128,5)</li><li>rois_label size= (1,128)</li><li>rois_target size= (1,128.4)</li><li>rois_inside_ws, size= (1,128,4)</li><li>rois_outside_ws size= (1,128,4)</li></ul><ol start="5" type="1"><li>self.RCNN_roi_align</li></ol><ul><li>pooled_feat size=(128, 1024, 7, 7)</li></ul><ol start="6" type="1"><li>head_to_tail</li></ol><ul><li>pooled_feat size=(128,2048)</li><li>query_feat size=(1,2048)</li></ul><ol start="7" type="1"><li>bbox_pred</li></ol><ul><li>size=(128,4)</li></ul><ol start="8" type="1"><li>cat 拼接roi和查询图像过R-CNN后的特征图pooled_feat 和query_feat</li></ol><ul><li><p>pooled_feat size=(128,4096)</p><p>猜测拼接后的结果是</p><table><thead><tr class="header"><th></th><th>roi[0:2048]</th><th>query[2048,4096]</th></tr></thead><tbody><tr class="odd"><td>0</td><td>roi0</td><td>query</td></tr><tr class="even"><td>1</td><td>roi1</td><td>query</td></tr><tr class="odd"><td>128</td><td>roi128</td><td>query</td></tr></tbody></table><p>bbox的损失用的拼接前的结果，score的损失用的拼接后的结果</p></li></ul><ol start="9" type="1"><li>RCNN_cls_score</li></ol><ul><li>score size=(128,2)</li><li>score_prob size=128 为score softmax后结果</li></ul><ol start="10" type="1"><li>R-CNN Loss cls</li></ol><ul><li>RCNN_loss_cls是score, rois_label的交叉熵</li></ul><ol start="11" type="1"><li>margin_loss</li></ol><ul><li>score_label size变为(1,128)</li><li>score_prob size变为(1,128)</li><li>gt_map=|score_label-score_label| 真值ground_turh size=(1,128,128)</li><li>pr_map=|score_prob-score_prob| 预测的predict size=(1,128,128)</li><li>target=-gt_map^2+3gt_map+1</li><li>margin_loss=3*self.triplet_loss()</li></ul><ol start="12" type="1"><li>RCNN_loss_bbox</li></ol><ul><li>RCNN_loss_bbox smooth-L1函数</li></ul></li><li><p>返回值</p><ul><li>rois</li><li>cls_prob</li><li>bbox_pred</li><li>rpn_loss_cls 用于反传</li><li>rpn_loss_bbox, 用于反传</li><li>RCNN_loss_cls, 用于反传</li><li>margin_loss, 用于反传</li><li>RCNN_loss_bbox， 用于反传</li><li>rois_label</li><li>c_weight</li></ul></li></ul></li></ul><h3 id="oneshotresnet.py">oneshotresnet.py</h3><h3 id="libmodelutilsnet_utils.py">lib/model/utils/net_utils.py</h3><h4 id="channelgate">ChannelGate</h4><p>用于squeeze</p><ul><li><p>__init__</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self, gate_channels: int, reduction_ratio: int = <span class="number">16</span>, pool_types: List[str] = [<span class="string">'avg'</span>, <span class="string">'max'</span>])</span></span></span><br></pre></td></tr></table></figure><ul><li>参数<ul><li>gate_channels：=1024(coco)</li></ul></li><li>成员变量<ul><li>self.mlp 输入为gate_channels-&gt;gate_channels/16-&gt;ReLU-&gt;gate_channels网络编码解码器</li></ul></li></ul></li><li><p>forward</p><ul><li><p>参数</p><ul><li>x 是non_aim size=(1,1024,8,8)</li></ul></li><li><p>返回值</p><p>size=(1,1024,1,1)</p></li><li><p>过程</p><ol type="1"><li>x全局平均池化</li><li>self.mlp</li><li>x全局最大池化</li><li>self.mlp</li><li>4加上2的结果</li><li>sigmoid并返回</li></ol></li></ul></li></ul><h3 id="libmodelrpnrpn.py">lib/model/rpn/rpn.py</h3><h4 id="rpn">_RPN</h4><ul><li><p>__init__</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self, din: int)</span>:</span></span><br></pre></td></tr></table></figure><p>参数为通道数，在coco中为1024</p></li><li><p>forward</p><ul><li>参数，均为torch.Tensor<ul><li>base_feat 为target Image的Non-local Feature size=(1,1024,57,38)</li><li>im_info size=(1,3) =[[900,600,1.4052]]</li><li>gt_boxes size=(1,50,5)</li><li>num_boxes boxes的数量size=1</li></ul></li><li>返回值 均为torch.Tensor<ul><li>rois size=(1,2000,5)</li><li>rpn_loss_cls=0.6905 标量 requires_grad=True</li><li>rpn_loss_bbox=0.0162标量 requires_grad=True</li></ul></li></ul></li></ul><h3 id="libmodelrpnproposal_target_layer_cascade.py">lib/model/rpn/proposal_target_layer_cascade.py</h3><h4 id="proposaltargetlayer">_ProposalTargetLayer</h4><ul><li><p>__init__</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self, nclasses: int)</span>:</span></span><br></pre></td></tr></table></figure></li><li><p>forward</p><ul><li>参数，均为torch.Tensor<ul><li>rois size=(1,2000,5)</li><li>gt_boxes size=(1,50,5)</li><li>num_boxes boxes的数量size=1</li></ul></li><li>返回值 均为torch.Tensor<ul><li>rois size=(1,128,5)</li><li>labels size= (1,128)</li><li>bbox_targets size= (1,128.4)</li><li>bbox_inside_weights, size= (1,128.4)</li><li>bbox_outside_weights size= (1,128.4)</li></ul></li></ul></li></ul></div><div><ul class="post-copyright"><li class="post-copyright-author"><strong>Post author:</strong> 侯德柱</li><li class="post-copyright-link"><strong>Post link:</strong> <a href="https://ironsublimate.github.io/2020/09/14/33845/" title="联合注意-联合激励代码分析">https://ironsublimate.github.io/2020/09/14/33845/</a></li><li class="post-copyright-license"><strong>Copyright Notice: </strong>All articles in this blog are licensed under <a href="https://creativecommons.org/licenses/by-nc-sa/3.0/" rel="external nofollow" target="_blank">CC BY-NC-SA 3.0</a> unless stating additionally.</li></ul></div><footer class="post-footer"><div class="post-tags"><a href="/tags/%E6%B7%B1%E5%BA%A6%E5%AD%A6%E4%B9%A0/" rel="tag"><i class="fa fa-tag"></i> 深度学习</a> <a href="/tags/%E7%9B%AE%E6%A0%87%E6%A3%80%E6%B5%8B/" rel="tag"><i class="fa fa-tag"></i> 目标检测</a></div><div class="post-nav"><div class="post-nav-next post-nav-item"><a href="/2020/09/14/27078/" rel="next" title="CenterNet代码分析"><i class="fa fa-chevron-left"></i> CenterNet代码分析</a></div><span class="post-nav-divider"></span><div class="post-nav-prev post-nav-item"></div></div></footer></div></article><div class="post-spread"></div></div></div></div><div class="sidebar-toggle"><div class="sidebar-toggle-line-wrap"><span class="sidebar-toggle-line sidebar-toggle-line-first"></span> <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span> <span class="sidebar-toggle-line sidebar-toggle-line-last"></span></div></div><aside id="sidebar" class="sidebar"><div class="sidebar-inner"><ul class="sidebar-nav motion-element"><li class="sidebar-nav-toc sidebar-nav-active" data-target="post-toc-wrap">Table of Contents</li><li class="sidebar-nav-overview" data-target="site-overview-wrap">Overview</li></ul><section class="site-overview-wrap sidebar-panel"><div class="site-overview"><div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person"><img class="site-author-image" itemprop="image" src="/images/avatar.png" alt="侯德柱"><p class="site-author-name" itemprop="name">侯德柱</p><p class="site-description motion-element" itemprop="description">这个人很懒，什么都没有写(´·＿·｀)</p></div><nav class="site-state motion-element"><div class="site-state-item site-state-posts"><a href="/archives/%7C%7C%20archive"><span class="site-state-item-count">5</span> <span class="site-state-item-name">posts</span></a></div><div class="site-state-item site-state-categories"><a href="/categories/index.html"><span class="site-state-item-count">2</span> <span class="site-state-item-name">categories</span></a></div><div class="site-state-item site-state-tags"><a href="/tags/index.html"><span class="site-state-item-count">3</span> <span class="site-state-item-name">tags</span></a></div></nav><div class="feed-link motion-element"><a href="/atom.xml" rel="alternate"><i class="fa fa-rss"></i> RSS</a></div><div class="links-of-author motion-element"><span class="links-of-author-item"><a href="https://github.com/IronSublimate" target="_blank" title="GitHub"><i class="fa fa-fw fa-github"></i>GitHub</a> </span><span class="links-of-author-item"><a href="mailto:houyuxuan3120487@163.com" target="_blank" title="E-Mail"><i class="fa fa-fw fa-envelope"></i>E-Mail</a></span></div></div></section><section class="post-toc-wrap motion-element sidebar-panel sidebar-panel-active"><div class="post-toc"><div class="post-toc-content"><ol class="nav"><li class="nav-item nav-level-1"><a class="nav-link" href="#coae源码分析"><span class="nav-number">1.</span> <span class="nav-text">CoAE源码分析</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#数据加载"><span class="nav-number">1.1.</span> <span class="nav-text">数据加载</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#libroi_data_layerroibatchloader.py"><span class="nav-number">1.1.1.</span> <span class="nav-text">lib&#x2F;roi_data_layer&#x2F;roibatchLoader.py</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#libroi_data_layerminibatch.py"><span class="nav-number">1.1.2.</span> <span class="nav-text">lib&#x2F;roi_data_layer&#x2F;minibatch.py</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#libroi_data_layerroidb.py"><span class="nav-number">1.1.3.</span> <span class="nav-text">lib&#x2F;roi_data_layer&#x2F;roidb.py</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#trainval_net.py"><span class="nav-number">1.1.4.</span> <span class="nav-text">trainval_net.py</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#sampler"><span class="nav-number">1.1.4.1.</span> <span class="nav-text">sampler</span></a></li></ol></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#数据集"><span class="nav-number">1.2.</span> <span class="nav-text">数据集</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#libdatasetsimdb.py"><span class="nav-number">1.2.1.</span> <span class="nav-text">lib&#x2F;datasets&#x2F;imdb.py</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#imdb"><span class="nav-number">1.2.1.1.</span> <span class="nav-text">imdb</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#libdatasetscoco.py"><span class="nav-number">1.2.2.</span> <span class="nav-text">lib&#x2F;datasets&#x2F;coco.py</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#coco"><span class="nav-number">1.2.2.1.</span> <span class="nav-text">coco</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#libdatasetsfactory.py"><span class="nav-number">1.2.3.</span> <span class="nav-text">lib&#x2F;datasets&#x2F;factory.py</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#自定义数据集"><span class="nav-number">1.2.4.</span> <span class="nav-text">自定义数据集</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#数据处理"><span class="nav-number">1.3.</span> <span class="nav-text">数据处理</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#libmodelutilblob.py"><span class="nav-number">1.3.1.</span> <span class="nav-text">lib&#x2F;model&#x2F;util&#x2F;blob.py</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#训练"><span class="nav-number">1.4.</span> <span class="nav-text">训练</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#魔改"><span class="nav-number">1.5.</span> <span class="nav-text">魔改</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#网络"><span class="nav-number">1.6.</span> <span class="nav-text">网络</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#oneshotbase.py"><span class="nav-number">1.6.1.</span> <span class="nav-text">oneshotbase.py</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#matchnet"><span class="nav-number">1.6.1.1.</span> <span class="nav-text">matchnet</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#oneshotbase"><span class="nav-number">1.6.1.2.</span> <span class="nav-text">OneShotBase</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#oneshotresnet.py"><span class="nav-number">1.6.2.</span> <span class="nav-text">oneshotresnet.py</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#libmodelutilsnet_utils.py"><span class="nav-number">1.6.3.</span> <span class="nav-text">lib&#x2F;model&#x2F;utils&#x2F;net_utils.py</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#channelgate"><span class="nav-number">1.6.3.1.</span> <span class="nav-text">ChannelGate</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#libmodelrpnrpn.py"><span class="nav-number">1.6.4.</span> <span class="nav-text">lib&#x2F;model&#x2F;rpn&#x2F;rpn.py</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#rpn"><span class="nav-number">1.6.4.1.</span> <span class="nav-text">_RPN</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#libmodelrpnproposal_target_layer_cascade.py"><span class="nav-number">1.6.5.</span> <span class="nav-text">lib&#x2F;model&#x2F;rpn&#x2F;proposal_target_layer_cascade.py</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#proposaltargetlayer"><span class="nav-number">1.6.5.1.</span> <span class="nav-text">_ProposalTargetLayer</span></a></li></ol></li></ol></li></ol></li></ol></div></div></section></div></aside></div></main><footer id="footer" class="footer"><div class="footer-inner"><div class="copyright">&copy; <span itemprop="copyrightYear">2020</span> <span class="with-love"><i class="fa fa-user"></i> </span><span class="author" itemprop="copyrightHolder">侯德柱</span></div><div class="powered-by">Powered by <a class="theme-link" target="_blank" href="https://hexo.io">Hexo</a></div><span class="post-meta-divider">|</span><div class="theme-info">Theme &mdash; <a class="theme-link" target="_blank" href="https://github.com/iissnan/hexo-theme-next">NexT.Pisces</a> v5.1.4</div><div class="busuanzi-count"><script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script><span class="site-uv"><i class="fa fa-user"></i> <span class="busuanzi-value" id="busuanzi_value_site_uv"></span> </span><span class="site-pv"><i class="fa fa-eye"></i> <span class="busuanzi-value" id="busuanzi_value_site_pv"></span></span></div></div></footer><div class="back-to-top"><i class="fa fa-arrow-up"></i> <span id="scrollpercent"><span>0</span>%</span></div></div><script type="text/javascript">"[object Function]"!==Object.prototype.toString.call(window.Promise)&&(window.Promise=null)</script><script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script><script type="text/javascript" src="/lib/fastclick/lib/fastclick.min.js?v=1.0.6"></script><script type="text/javascript" src="/lib/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script><script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script><script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script><script type="text/javascript" src="/lib/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script><script type="text/javascript" src="/lib/canvas-nest/canvas-nest.min.js"></script><script type="text/javascript" src="/js/src/utils.js?v=5.1.4"></script><script type="text/javascript" src="/js/src/motion.js?v=5.1.4"></script><script type="text/javascript" src="/js/src/affix.js?v=5.1.4"></script><script type="text/javascript" src="/js/src/schemes/pisces.js?v=5.1.4"></script><script type="text/javascript" src="/js/src/scrollspy.js?v=5.1.4"></script><script type="text/javascript" src="/js/src/post-details.js?v=5.1.4"></script><script type="text/javascript" src="/js/src/bootstrap.js?v=5.1.4"></script><script type="text/x-mathjax-config">MathJax.Hub.Config({
        tex2jax: {
          inlineMath: [ ['$','$'], ["\\(","\\)"]  ],
          processEscapes: true,
          skipTags: ['script', 'noscript', 'style', 'textarea', 'pre', 'code']
        }
      });</script><script type="text/x-mathjax-config">MathJax.Hub.Queue(function() {
        var all = MathJax.Hub.getAllJax(), i;
        for (i=0; i < all.length; i += 1) {
          all[i].SourceElement().parentNode.className += ' has-jax';
        }
      });</script><script type="text/javascript" src="//cdn.bootcss.com/mathjax/2.7.1/latest.js?config=TeX-AMS-MML_HTMLorMML"></script><script src="/live2dw/lib/L2Dwidget.min.js?094cbace49a39548bed64abff5988b05"></script><script>L2Dwidget.init({pluginModelPath:"assets/",model:{jsonPath:"/live2dw/assets/z16.model.json"},display:{position:"right",width:300,height:600},mobile:{show:!1},rect:"opacity:0.7",log:!1,pluginJsPath:"lib/",pluginRootPath:"live2dw/",tagMode:!1})</script></body></html><!-- rebuild by neat -->